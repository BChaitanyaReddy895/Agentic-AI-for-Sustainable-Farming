<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ T.title|default('Sustainable Farming Recommendation System') }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #1a2a44, #2a4d69); color: #fff; overflow-x: hidden; }
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .content-overlay { background: rgba(26, 42, 68, 0.9); z-index: 10; min-height: 100vh; }
        .card-3d { transition: transform 0.3s, box-shadow 0.3s; transform-style: preserve-3d; perspective: 1000px; }
        .card-3d:hover { transform: translateZ(20px) scale(1.05); box-shadow: 0 15px 30px rgba(0, 255, 133, 0.3); }
        .logo { text-shadow: 0 0 15px #00ff85; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { text-shadow: 0 0 5px #00ff85; } 50% { text-shadow: 0 0 20px #00ff85; } }
        .fade-in { animation: fadeIn 1s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .particle { position: fixed; background: rgba(0, 255, 133, 0.4); border-radius: 50%; animation: float 20s infinite linear; pointer-events: none; }
        @keyframes float { 0% { transform: translateY(100vh) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        .tab { display: none; }
        .tab.active { display: block; }
        nav a {
            color: #4fd1c5; /* text-teal-300 */
            transition-property: color;
            transition-duration: 150ms;
        }
        nav a:hover {
            color: #38d9a9; /* text-green-400 */
        }
        .instruction {
            font-size: 0.875rem; /* text-sm */
            color: #d1d5db;      /* text-gray-300 */
            font-style: italic;  /* italic */
            margin-top: 0.5rem;  /* mt-2 */
        }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div class="content-overlay">
        <header class="p-6 flex justify-between items-center shadow-lg">
            <div class="logo flex items-center space-x-3 text-3xl font-bold">
                <span>ðŸŒ¾</span> {{ T.title|default('Sustainable Farming') }}
            </div>
            <nav class="space-x-6">
                {% if user %}
                    <a href="#" onclick="showTab('dashboard')">{{ T.dashboard }}</a>
                    <a href="#" onclick="showTab('profile')">{{ T.profile }}</a>
                    <a href="/logout">{{ T.logout }}</a>
                {% else %}
                    <a href="/login">Login</a>
                    <a href="/signup">Sign Up</a>
                {% endif %}
                <a href="#" onclick="showTab('farm')">Farm</a>
                <a href="#" onclick="showTab('recommend')">Recommend</a>
                <a href="#" onclick="showTab('rotation')">Rotation</a>
                <a href="#" onclick="showTab('fertilizer')">Fertilizer</a>
                <a href="#" onclick="showTab('sustainability')">Sustainability</a>
                <a href="#" onclick="showTab('map')">Map</a>
                <a href="#" onclick="showTab('community')">Community</a>
                <a href="#" onclick="showTab('market')">Market</a>
                <a href="#" onclick="showTab('chat')">Chat</a>
                <a href="#" onclick="showTab('offline')">Offline</a>
                <a href="#" onclick="showTab('contact')">Contact</a>
            </nav>
            <select id="lang-select" onchange="changeLang(this.value)" class="p-2 bg-gray-800 text-white rounded-lg">
                {% for lang_code in languages.keys() %}
                    <option value="{{ lang_code }}" {% if lang_code == lang %}selected{% endif %}>{{ lang_code }}</option>
                {% endfor %}
            </select>
        </header>

        <main class="container mx-auto p-6">
            <div id="dashboard" class="tab active">
                <h1 class="text-4xl font-bold text-green-400 text-center mb-6 fade-in">{{ T.title|default('Sustainable Farming') }}</h1>
                <p class="instruction">{{ T.instructions|default('Use the navigation to explore features.') }}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    <div class="card-3d bg-gray-800 p-6 rounded-lg shadow-md hover:bg-gray-700 cursor-pointer" onclick="showTab('farm')">
                        <h3 class="text-xl text-teal-300">{{ T.farm_details|default('Farm Details') }}</h3>
                        <p class="text-gray-400">Enter and manage your farm data.</p>
                    </div>
                    <div class="card-3d bg-gray-800 p-6 rounded-lg shadow-md hover:bg-gray-700 cursor-pointer" onclick="showTab('recommend')">
                        <h3 class="text-xl text-teal-300">{{ T.generate_recommendation|default('Generate Recommendation') }}</h3>
                        <p class="text-gray-400">Get AI-driven farming advice.</p>
                    </div>
                    <div class="card-3d bg-gray-800 p-6 rounded-lg shadow-md hover:bg-gray-700 cursor-pointer" onclick="showTab('market')">
                        <h3 class="text-xl text-teal-300">Market Insights</h3>
                        <p class="text-gray-400">Forecast crop prices with confidence.</p>
                    </div>
                    <div class="card-3d bg-gray-800 p-6 rounded-lg shadow-md hover:bg-gray-700 cursor-pointer" onclick="showTab('chat')">
                        <h3 class="text-xl text-teal-300">{{ T.chat|default('Chat') }}</h3>
                        <p class="text-gray-400">Chat with our AI assistant.</p>
                    </div>
                    <div class="card-3d bg-gray-800 p-6 rounded-lg shadow-md hover:bg-gray-700 cursor-pointer" onclick="showTab('sustainability')">
                        <h3 class="text-xl text-teal-300">Sustainability</h3>
                        <p class="text-gray-400">Track your eco-friendly score.</p>
                    </div>
                    <div class="card-3d bg-gray-800 p-6 rounded-lg shadow-md hover:bg-gray-700 cursor-pointer" onclick="showTab('map')">
                        <h3 class="text-xl text-teal-300">Farm Map</h3>
                        <p class="text-gray-400">Visualize your land layout.</p>
                    </div>
                </div>
            </div>

            <div id="farm" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.farm_details|default('Farm Details') }}</h2>
                <p class="instruction">Enter your farm size (in hectares) and crop preference.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="land-size" type="number" placeholder="Farm Size (ha)" class="p-2 bg-gray-700 rounded">
                    <select id="crop-pref" class="p-2 bg-gray-700 rounded">
                        <option>Grains</option>
                        <option>Vegetables</option>
                        <option>Fruits</option>
                    </select>
                </div>
                <h3 class="text-lg text-teal-300 mt-4">{{ T.soil_analysis|default('Soil Analysis') }}</h3>
                <p class="instruction">Upload a soil photo or select manually.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="file" id="soil-photo" accept="image/*" class="p-2 bg-gray-700 rounded">
                    <select id="manual-soil" class="p-2 bg-gray-700 rounded">
                        <option>{{ T.select_soil_type|default('Select soil type') }}</option>
                        <option>Loamy</option>
                        <option>Sandy</option>
                        <option>Clay</option>
                    </select>
                </div>
                <button onclick="analyzeSoil()" class="mt-4 bg-green-500 hover:bg-green-600 p-2 rounded text-white">Analyze Soil</button>
                <div id="soil-result" class="mt-2 text-gray-300"></div>
            </div>

            <div id="recommend" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.generate_recommendation|default('Generate Recommendation') }}</h2>
                <p class="instruction">Click to generate recommendations based on your farm data.</p>
                <button onclick="generateRec()" class="bg-green-500 hover:bg-green-600 p-2 rounded text-white">Generate</button>
                <div id="rec-output" class="mt-4 text-gray-300"></div>
                <canvas id="rec-chart" class="mt-4 w-full h-64"></canvas>
            </div>

            <div id="rotation" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.crop_rotation_planner|default('Crop Rotation Planner') }}</h2>
                <p class="instruction">Get a 3-month crop rotation plan.</p>
                <button onclick="getRotation()" class="bg-green-500 hover:bg-green-600 p-2 rounded text-white">Get Plan</button>
                <div id="rotation-plan" class="mt-4 text-gray-300"></div>
                <canvas id="rotation-chart" class="mt-4 w-full h-64"></canvas>
            </div>

            <div id="fertilizer" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.fertilizer_optimization|default('Fertilizer Optimization') }}</h2>
                <p class="instruction">Enter land size and select soil/crop for optimization.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="fert-soil" class="p-2 bg-gray-700 rounded">
                        <option>Loamy</option>
                        <option>Sandy</option>
                        <option>Clay</option>
                    </select>
                    <select id="fert-crop" class="p-2 bg-gray-700 rounded">
                        <option>Wheat</option>
                        <option>Corn</option>
                        <option>Rice</option>
                    </select>
                    <input id="fert-land" type="number" placeholder="Land (ha)" class="p-2 bg-gray-700 rounded">
                </div>
                <button onclick="optimizeFert()" class="mt-4 bg-green-500 hover:bg-green-600 p-2 rounded text-white">Optimize</button>
                <div id="fert-result" class="mt-2 text-gray-300"></div>
            </div>

            <div id="sustainability" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.sustainability|default('Sustainability Tracker') }}</h2>
                <p class="instruction">Log water and fertilizer use to calculate your score.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="water-use" type="number" placeholder="Water (ML/ha)" class="p-2 bg-gray-700 rounded">
                    <input id="fert-use" type="number" placeholder="Fertilizer (tons/ha)" class="p-2 bg-gray-700 rounded">
                    <label class="flex items-center"><input type="checkbox" id="rotation-yes"> Crop Rotation</label>
                </div>
                <button onclick="logSustainability()" class="mt-4 bg-green-500 hover:bg-green-600 p-2 rounded text-white">Log Score</button>
                <canvas id="sust-chart" class="mt-4 w-full h-64"></canvas>
            </div>

            <div id="map" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.map_title|default('Interactive Farm Map') }}</h2>
                <p class="instruction">Save or load your farm layout (mock map).</p>
                <div id="map-container" style="height: 400px; border: 1px solid #00ff85;" class="rounded-lg bg-gray-800"></div>
                <div class="flex gap-4 mt-4">
                    <button onclick="saveMap()" class="bg-green-500 hover:bg-green-600 p-2 rounded text-white">Save Map</button>
                    <button onclick="loadMap()" class="bg-green-500 hover:bg-green-600 p-2 rounded text-white">Load Map</button>
                </div>
            </div>

            <div id="community" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.community_insights|default('Community Insights') }}</h2>
                <p class="instruction">Share your data to contribute to community insights.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="comm-crop" class="p-2 bg-gray-700 rounded">
                        <option>Rice</option>
                        <option>Wheat</option>
                    </select>
                    <input id="yield-data" type="number" placeholder="Yield (tons/ha)" class="p-2 bg-gray-700 rounded">
                    <input id="market-price" type="number" placeholder="Price ($/ton)" class="p-2 bg-gray-700 rounded">
                    <select id="region" class="p-2 bg-gray-700 rounded">
                        <option>North</option>
                        <option>South</option>
                    </select>
                </div>
                <button onclick="shareCommunity()" class="mt-4 bg-green-500 hover:bg-green-600 p-2 rounded text-white">Share Data</button>
                <canvas id="comm-chart" class="mt-4 w-full h-64"></canvas>
            </div>

            <div id="market" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.market_forecasting|default('Market Forecasting') }}</h2>
                <p class="instruction">Select crop and period to predict prices.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="forecast-crop" class="p-2 bg-gray-700 rounded">
                        <option>Rice</option>
                        <option>Wheat</option>
                    </select>
                    <select id="forecast-period" class="p-2 bg-gray-700 rounded">
                        <option>3 months</option>
                        <option>6 months</option>
                    </select>
                    <button onclick="generateForecast()" class="bg-green-500 hover:bg-green-600 p-2 rounded text-white">Generate Forecast</button>
                </div>
                <canvas id="market-chart" class="mt-4 w-full h-64"></canvas>
            </div>

            <div id="chat" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.chat|default('Chat') }}</h2>
                <p class="instruction">Ask farming-related questions to our AI assistant.</p>
                <div id="chat-history" class="p-4 bg-gray-700 rounded-lg mb-4 max-h-40 overflow-y-auto"></div>
                <div class="flex gap-4">
                    <input id="chat-input" placeholder="Type your question..." class="p-2 flex-1 bg-gray-700 rounded">
                    <button onclick="sendChat()" class="bg-green-500 hover:bg-green-600 p-2 rounded text-white">Send</button>
                    <button onclick="clearChat()" class="bg-red-500 hover:bg-red-600 p-2 rounded text-white">Clear</button>
                </div>
            </div>

            <div id="offline" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.offline|default('Offline Mode') }}</h2>
                <p class="instruction">Enable offline mode to work without internet.</p>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="offline-toggle" onchange="toggleOffline()">
                    {{ T.offline }}
                </label>
                <button onclick="syncOffline()" class="mt-4 bg-green-500 hover:bg-green-600 p-2 rounded text-white">Sync Data</button>
                <div id="offline-status" class="mt-2 text-gray-300"></div>
            </div>

            <div id="profile" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.profile|default('Profile') }}</h2>
                <p class="instruction">Update your details or view past recommendations.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="edit-username" placeholder="{{ T.username|default('Username') }}" value="{{ user.username if user else '' }}" class="p-2 bg-gray-700 rounded">
                    <input id="edit-farm" placeholder="{{ T.farm_name|default('Farm Name') }}" value="{{ user.farm_name if user else '' }}" class="p-2 bg-gray-700 rounded">
                </div>
                <button onclick="updateProfile()" class="mt-4 bg-green-500 hover:bg-green-600 p-2 rounded text-white">Save Changes</button>
                <h3 class="text-lg text-teal-300 mt-4">{{ T.previous_recommendations }}</h3>
                <div id="profile-recs" class="mt-2 text-gray-300"></div>
            </div>

            <div id="contact" class="tab">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">{{ T.contact_us }}</h2>
                <p class="instruction">{{ T.contact_desc }}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input placeholder="Your Name" class="p-2 bg-gray-700 rounded">
                    <input placeholder="Your Email" class="p-2 bg-gray-700 rounded">
                    <textarea placeholder="Your Message" rows="4" class="p-2 bg-gray-700 rounded md:col-span-2"></textarea>
                </div>
                <button onclick="sendContact()" class="mt-4 bg-green-500 hover:bg-green-600 p-2 rounded text-white">Send Message</button>
            </div>
        </main>

        <footer class="bg-gray-800 p-4 text-center shadow-lg mt-6">
            <p class="text-teal-300">{{ T.built_with }}</p>
            <p class="text-sm text-gray-400">{{ T.last_updated }} {{ current_time }}</p>
        </footer>
    </div>

    <script>
        let currentLang = '{{ lang }}';
        const translations = JSON.parse('{{ (T|default({}))|tojson|safe }}');
        let user_json = '{{ (user|default(None))|tojson|safe }}';
        let user = null;
        try {
            user = JSON.parse(user_json);
        } catch (e) {
            user = null;
        }
        let charts = {};

        // 3D Background with Particles
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 200;
        const posArray = new Float32Array(particlesCount * 3);
        for (let i = 0; i < particlesCount * 3; i++) posArray[i] = (Math.random() - 0.5) * 100;
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMaterial = new THREE.PointsMaterial({ color: 0x00ff85, size: 0.5, transparent: true });
        const particles = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particles);

        camera.position.z = 50;
        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.y += 0.001;
            renderer.render(scene, camera);
        }
        animate();

        // Add CSS Particles
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + 'vw';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.width = particle.style.height = Math.random() * 4 + 2 + 'px';
            document.body.appendChild(particle);
        }

        // Tab Navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        // Language Change
        function changeLang(lang) {
            currentLang = lang;
            fetch(`/api/change_lang?lang=${lang}`, { method: 'POST' }).then(() => location.reload());
        }

        // Authentication
        async function signup() {
            const username = document.getElementById('signup-username').value;
            const farmName = document.getElementById('signup-farm').value;
            const res = await fetch('/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&farm_name=${encodeURIComponent(farmName)}`
            });
            const data = await res.text();
            alert(data || translations['signup_success'].format(username=username));
            if (!data) location.href = '/';
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}`
            });
            const data = await res.text();
            if (data.includes('error')) alert(data);
            else location.href = '/';
        }

        // Soil Analysis
        async function analyzeSoil() {
            const photo = document.getElementById('soil-photo').files[0];
            const manualSoil = document.getElementById('manual-soil').value;
            let formData = new FormData();
            if (photo) formData.append('photo', photo);
            else formData.append('manual_soil', manualSoil);
            const res = await fetch('/api/soil_analysis', { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById('soil-result').innerHTML = `Soil Type: ${data.soil_type}`;
        }

        // Generate Recommendation
        async function generateRec() {
            const landSize = document.getElementById('land-size').value;
            const soilType = document.getElementById('manual-soil').value || 'Loamy';
            const cropPref = document.getElementById('crop-pref').value;
            const res = await fetch('/api/generate_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ land_size: landSize, soil_type: soilType, crop_preference: cropPref })
            });
            const data = await res.json();
            document.getElementById('rec-output').innerHTML = data.recommendations.map(r => `<p>${r.crop}: ${r.score}% - ${r.rationale}</p>`).join('');
            if (charts.rec) charts.rec.destroy();
            const ctx = document.getElementById('rec-chart').getContext('2d');
            charts.rec = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.recommendations.map(r => r.crop), datasets: [{ label: 'Score', data: data.recommendations.map(r => r.score), backgroundColor: '#00ff85' }] },
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        // Crop Rotation
        async function getRotation() {
            const res = await fetch('/api/crop_rotation');
            const data = await res.json();
            document.getElementById('rotation-plan').innerHTML = `<ul>${data.plan.map(p => `<li>${p}</li>`).join('')}</ul>`;
            if (charts.rotation) charts.rotation.destroy();
            const ctx = document.getElementById('rotation-chart').getContext('2d');
            charts.rotation = new Chart(ctx, {
                type: 'line',
                data: { labels: ['Month 1', 'Month 2', 'Month 3'], datasets: [{ label: 'Rotation', data: [1, 2, 3], borderColor: '#00ff85' }] }
            });
        }

        // Fertilizer Optimize
        async function optimizeFert() {
            const soil = document.getElementById('fert-soil').value;
            const crop = document.getElementById('fert-crop').value;
            const land = document.getElementById('fert-land').value;
            const res = await fetch('/api/fertilizer_optimize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ soil, crop, land })
            });
            const data = await res.json();
            document.getElementById('fert-result').innerHTML = `NPK: ${data.npk}, Total: ${data.total} kg`;
        }

        // Sustainability Log
        async function logSustainability() {
            const water = parseFloat(document.getElementById('water-use').value) || 0;
            const fertilizer = parseFloat(document.getElementById('fert-use').value) || 0;
            const rotation = document.getElementById('rotation-yes').checked;
            const res = await fetch('/api/sustainability_log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ water, fertilizer, rotation })
            });
            const data = await res.json();
            alert(`Sustainability Score: ${data.score}%`);
            const resHist = await fetch('/api/sustainability_history');
            const history = await resHist.json();
            if (charts.sust) charts.sust.destroy();
            const ctx = document.getElementById('sust-chart').getContext('2d');
            charts.sust = new Chart(ctx, {
                type: 'line',
                data: { labels: history.map(h => h.timestamp), datasets: [{ label: 'Score', data: history.map(h => h.score), borderColor: '#00ff85' }] }
            });
        }

        // Farm Map
        function saveMap() {
            const mapData = { center: [12.97, 77.59], zones: [{ lat: 12.98, lng: 77.60, label: 'Field 1' }] };
            fetch('/api/farm_map_save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ map_data: mapData })
            }).then(res => res.json()).then(data => alert('Map saved!'));
        }

        async function loadMap() {
            const res = await fetch('/api/farm_map_load');
            const data = await res.json();
            document.getElementById('map-container').innerHTML = data.map_data.zones.map(z => `<p>${z.label}: ${z.lat}, ${z.lng}</p>`).join('') || 'No map data.';
        }

        // Community
        async function shareCommunity() {
            const crop = document.getElementById('comm-crop').value;
            const yieldData = parseFloat(document.getElementById('yield-data').value) || 0;
            const marketPrice = parseFloat(document.getElementById('market-price').value) || 0;
            const region = document.getElementById('region').value;
            await fetch('/api/community_share', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ crop, yield: yieldData, price: marketPrice, region, season: 'Kharif', practice: 'Organic' })
            });
            alert('Data shared!');
            const res = await fetch('/api/community_insights');
            const insights = await res.json();
            if (charts.comm) charts.comm.destroy();
            const ctx = document.getElementById('comm-chart').getContext('2d');
            charts.comm = new Chart(ctx, {
                type: 'bar',
                data: { labels: insights.map(i => i.crop_type), datasets: [{ label: 'Avg Yield', data: insights.map(i => i.avg_yield), backgroundColor: '#00ff85' }] }
            });
        }

        // Market Forecast
        async function generateForecast() {
            const crop = document.getElementById('forecast-crop').value;
            const period = document.getElementById('forecast-period').value;
            const res = await fetch('/api/market_forecast', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ crop, period })
            });
            const data = await res.json();
            if (charts.market) charts.market.destroy();
            const ctx = document.getElementById('market-chart').getContext('2d');
            charts.market = new Chart(ctx, {
                type: 'line',
                data: { labels: data.forecasts.map(f => f.month), datasets: [{ label: 'Price ($)', data: data.forecasts.map(f => f.price), borderColor: '#00ff85', fill: false }] }
            });
        }

        // Chat
        async function sendChat() {
            const query = document.getElementById('chat-input').value;
            if (query) {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();
                const history = document.getElementById('chat-history');
                history.innerHTML += `<div class="mb-2"><strong>You:</strong> ${query}</div><div class="mb-2"><strong>AI:</strong> ${data.response}</div>`;
                history.scrollTop = history.scrollHeight;
                document.getElementById('chat-input').value = '';
            }
        }

        function clearChat() {
            document.getElementById('chat-history').innerHTML = '';
        }

        // Offline
        function toggleOffline() {
            const enabled = document.getElementById('offline-toggle').checked;
            if (enabled) {
                localStorage.setItem('offline', 'true');
                document.getElementById('offline-status').innerHTML = 'Offline mode enabled. Data saved locally.';
            } else {
                localStorage.removeItem('offline');
                document.getElementById('offline-status').innerHTML = '';
            }
        }

        async function syncOffline() {
            await fetch('/api/offline_sync', { method: 'POST' });
            document.getElementById('offline-status').innerHTML = 'Data synced successfully.';
        }

        // Profile
        async function updateProfile() {
            const username = document.getElementById('edit-username').value || (user && user.username) || '';
            const farm = document.getElementById('edit-farm').value || (user && user.farm_name) || '';
            // Mock update (real update would require API)
            user = { username, farm_name: farm };
            alert('Profile updated!');
            const res = await fetch('/api/previous_recommendations');
            const recs = await res.json();
            document.getElementById('profile-recs').innerHTML = recs.map(r => `<p>${r.crop}: ${r.score}% (${r.timestamp})</p>`).join('');
        }

        // Contact
        function sendContact() {
            alert('Message sent to support team! (Mock)');
        }

        // Initialize
        if (window.location.pathname === '/') showTab('dashboard');
        else showTab(window.location.pathname.slice(1) || 'dashboard');
    </script>
</body>
</html>